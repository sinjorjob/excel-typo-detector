# Excel誤字脱字検出ツール 設計書

## 0. 全体の処理フロー

```
[Excel読込] → [機械的検出] → [LLMレビュー] → [結果統合] → [出力]
   |             |             |            |           |
  .xlsx      用語統一チェック   文脈理解      重複除去    レビュー台帳.xlsx
 (複数)      表記ゆれ検出     高精度判定    優先度制御   統計情報.json
           (元テキスト使用)  (元テキスト使用)
```

* **ハイブリッド検出**: 機械的検出（クロスファイル用語統一）+ LLM検出（文脈理解）の組み合わせ
* **機械的検出**: クロスファイル用語統一チェックによる表記ゆれの確実な検出（正規化なし）
* **LLMレビュー**: システム設計書専門のプロンプトで文脈理解による誤字・脱字検出（元テキスト使用）
* **結果統合**: 重複除去と優先度制御により最適な修正提案を実現

---

## 1. 目的

Excel設計書から**誤字・誤変換・脱字**と**表記ゆれ**を機械的検出とLLMの組み合わせで高精度検出し、適切な修正提案を行う。
**技術用語を保護**しつつ、**元テキストの文脈**を正確に理解した実用的な校正支援を実現。

## 2. スコープ

* **入力**：`.xlsx`（複数ファイル対応）
* **出力**：
  * **レビュー台帳.xlsx**（検出一覧・修正提案・信頼度）
  * **統計情報.json**（誤字・表記ゆれ別件数、信頼度分布）
  * **LLMリクエストログ**（詳細な判定記録）

## 3. フォルダ構成

```
excel-checker/
  ├─ data/
  │   ├─ input/                 # .xlsx を置く
  │   └─ output/                # 結果が出る
  ├─ dict/
  │   ├─ canonicals.yml         # 表記ゆれの統一ルール
  │   └─ excludes.yml           # 除外ルール
  ├─ src/                       # 実装
  │   ├─ extract.py            # Excel読み込み
  │   ├─ mechanical_detector.py # 機械的検出（クロスファイル用語統一）
  │   ├─ llm.py               # LLMレビュー機能
  │   └─ report.py            # レポート生成
  ├─ config.yml                # 設定ファイル
  ├─ main.py                   # メイン実行ファイル
  ├─ requirements.txt          # 依存関係
  └─ README.md                 # 使用方法
```

---

## 4. 辞書システム

### 4.1 `dict/canonicals.yml`（表記統一ルール）

* **目的**：表記ゆれの統一ルールを定義
* **LLM連携**：プロンプトに含めて文脈に応じた適用を指示

```yaml
rules:
  - expected: "ユーザー"
    patterns: ["ユーザ", "ﾕｰｻﾞ", "user"]
    
  - expected: "データベース"
    patterns: ["DB", "ﾃﾞｰﾀﾍﾞｰｽ", "データ・ベース"]
    
  - expected: "ログイン"
    patterns: ["ログ・イン", "login", "log in", "log-in"]
```

### 4.2 `dict/excludes.yml`（除外ルール）

* **目的**：検査対象から除外する語を定義

```yaml
excludes:
  - "Azure AD"
  - "Ver.1.0.0"
  - "API仕様"
```

### 4.3 技術用語の扱い

LLMプロンプト内で以下の保護機能を実装：
- テーブル名・カラム名・API名等の技術用語は英語のまま維持
- DB設計、API仕様でのアルファベット表記は変更しない

---

## 5. 機械的検出システム

### 5.1 クロスファイル用語統一チェック

**検出原理**: ファイル間・シート間・セル間での用語表記の統一性をチェック

**処理フロー**:
1. 全ファイル・全シートから用語を抽出（元テキストから直接）
2. 文字種別ごと（ひらがな・全角カタカナ・半角カタカナ・漢字・英数字）に用語を分割
3. 抽出した用語をそのままキーとして、同一概念の異なる表記を収集（正規化なし）
4. 複数の表記が存在する場合、表記ゆれ（variant）として検出
5. canonical rules（canonicals.yml）で修正案を提案、または不統一を指摘

### 5.2 機械的検出パターン一覧表

| パターン種別 | 検出例 | 検出方法 | 信頼度 |
|-------------|-------|----------|--------|
| **全角/半角カタカナ** | 「ログイン」⇔「ﾛｸﾞｲﾝ」 | 文字種別抽出により同一用語の文字種違いを検出 | 0.90 |
| **語尾統一** | 「ユーザー」⇔「ユーザ」 | 構成要素レベルでの類似性による表記違い検出 | 0.90 |
| **記号表記** | 「データベース」⇔「データ・ベース」 | 記号の有無による表記違い検出 | 0.85 |
| **英語/日本語** | 「DB」⇔「データベース」 | canonicals.ymlルールによる対応付け | 0.90 |
| **構成要素混在** | 「ﾕｰｻﾞ設定」⇔「ユーザー管理」 | 文字種別分割により構成要素レベルで統一チェック | 0.85 |
| **複合語分離** | 「ログ・イン」⇔「ログイン」 | 区切り文字の有無による表記違い検出 | 0.85 |
| **英数字混在** | 「API仕様」⇔「api仕様」 | canonicals.ymlルールまたは大文字/小文字チェックによる検出 | 0.85 |

### 5.3 用語抽出アルゴリズム

**抽出ロジック**:
1. **全体抽出**: セルのテキスト全体を1つの用語として抽出（元テキストから直接）
2. **構成要素抽出**: 文字種別パターンで分割して抽出
   - ひらがな: `[ぁ-ん]+`
   - 全角カタカナ: `[ァ-ヶー]+`
   - 半角カタカナ: `[ｦ-ﾟ]+` ← 半角カタカナも正確に抽出
   - 漢字: `[一-龯]+`
   - 英数字: `[a-zA-Z0-9]+`
3. **最小長制限**: 2文字以上の用語のみ対象
4. **重複出現チェック**: 複数箇所に出現する用語のみ統一チェック対象
5. **正規化なし**: 抽出した用語をそのままキーとして使用

### 5.4 信頼度と優先度

**高信頼度検出**: 
- canonical rules適用: 0.90（明確な統一ルール）
- 表記不統一指摘: 0.85（統一性の問題）

**優先度制御**:
- 機械的検出（variant）> LLM検出（variant）
- LLM検出（typo）> 機械的検出（variant）
- 同一セル・同一テキストの重複は自動除去

---

## 6. LLMレビューシステム

### 6.1 システムプロンプト設計

**役割**: システム設計書専門の誤字脱字検出アシスタント

**入力データ**: 元のテキストデータ（正規化処理なし）
- 理由: 表記ゆれや半角カタカナなどの違いを正確に検出するため、原文の形を保持

**思考プロセス**:
1. 語句の意味理解: システム設計書の文脈で意味をなすか判断
2. 同音異義語チェック: 似た音の別の語句が文脈により適切ではないか検証
3. 専門用語確認: ビジネス・IT・会計分野の専門用語として正しいか評価
4. 完全性検証: 語句が完全で、文字の欠落や余分な文字がないか確認
5. 修正案生成: 文脈に最も適した完全で自然な語句を提案

### 6.2 技術用語保護機能

**重要な制限事項**:
- 技術仕様（DB設計、API仕様等）でのアルファベット表記は変更しない
- テーブル名・カラム名・関数名・変数名等の技術用語は英語のまま維持
- 文書内容・説明文でのみ表記統一ルールを適用

### 6.3 バッチ処理

- **処理単位**: 20セル/リクエスト
- **効率化**: 類似セルをまとめて送信
- **信頼度フィルタ**: 0.7以上のみ出力

### 6.4 出力フォーマット

```json
{
  "issue_type": "variant" | "typo" | "none",
  "original": "検出対象テキスト",
  "suggested_fix": "修正案",
  "canonical": "正準表記（表記ゆれの場合）",
  "reason": "判定理由",
  "confidence": 0.85
}
```

---

## 7. 結果統合システム

### 7.1 重複除去と優先度制御

**統合ルール**:
1. 同一セル・同一テキストの検出結果は重複として統合
2. 機械的検出（variant）とLLM検出（variant）→ 機械的検出を優先
3. 機械的検出（variant）とLLM検出（typo）→ LLM検出を優先
4. その他の組み合わせ → より高信頼度の結果を優先

### 7.2 品質保証

- **確実性**: 機械的検出は100%確実な表記ゆれ
- **網羅性**: LLM検出で文脈理解による広範囲な問題検出
- **効率性**: 重複除去により最適化された修正提案

---

## 8. 問題分類システム

### 8.1 タイプ分類

- **typo**: 誤字・誤変換・脱字
  - 例: "感情科目" → "勘定科目"
  - 例: "入力懸賞必須" → "入力検証必須"

- **variant**: 表記ゆれ
  - 例: "ユーザ" → "ユーザー"
  - canonicals.ymlヒット時は自動的にvariantに分類

- **none**: 問題なし
  - 正しい表記として判定

### 8.2 信頼度レベル

- **高信頼度 (≥0.9)**: LLMが非常に確信
- **中信頼度 (0.7-0.9)**: ある程度確信
- **低信頼度 (<0.7)**: 不確実（出力されない）

---

## 9. レポート生成

### 9.1 サマリーシート

統計情報を分かりやすく表示:
- 総検出数（機械的検出 + LLM検出の統合後）
- 機械的検出件数（表記ゆれ）
- LLM検出件数（誤字・表記ゆれ）
- 誤字件数・表記ゆれ件数の内訳
- 信頼度別分布
- LLMリクエスト回数

### 9.2 LLMレビュー結果シート

詳細な検出結果:
- ファイル名・シート名・セル位置
- 元テキスト・修正案・正準表記
- 問題タイプ・理由・信頼度
- 修正が必要な項目をハイライト表示

---

## 10. 設定システム

### 10.1 config.yml構造

```yaml
# LLM設定
llm:
  enabled: true
  provider: "openai"
  model: "gpt-4o"
  batch_size: 20
  min_confidence: 0.70
  temperature: 0.1

# 出力設定
output:
  review_book: "data/output/レビュー台帳.xlsx"
  llm_json: "data/output/llm_review.json"

# 処理設定
processing:
  max_cells_per_sheet: 10000
  skip_empty_cells: true
  include_formulas: false

# 除外設定
exclusions:
  skip_sheets: ["設定", "Config", "メモ"]
  skip_cell_patterns: ["^=.*", "^[0-9]+$"]
```

---

## 11. 実行方法

### 11.1 基本実行

```bash
# 仮想環境アクティベーション
cd venv && Scripts\activate && cd ..

# 実行
python main.py data/input
```

### 11.2 設定カスタマイズ

```bash
python main.py --config custom.yml data/input
```

---

## 12. 品質基準

### 12.1 性能目標

- **検出精度**: 文脈理解による適切な判定
- **処理速度**: バッチ処理による効率化
- **信頼性**: 0.7以上の信頼度での出力

### 12.2 安全性

- **技術用語保護**: DB・API仕様等の英語表記維持
- **重複検出除去**: 同一の original/suggested_fix は除外
- **文脈考慮**: システム設計書特有の用語への対応

---

## 13. 運用ガイドライン

### 13.1 辞書メンテナンス

1. **表記ゆれ**: レビュー台帳で繰り返し検出される統一ルールをcanonicals.ymlに追加
2. **除外語**: 誤検知が発生した固有名詞・技術用語をexcludes.ymlに追加

### 13.2 設定調整

1. **信頼度閾値**: 検出感度に応じてmin_confidenceを調整（0.7-0.9）
2. **バッチサイズ**: API制限に応じてbatch_sizeを調整（10-30）
3. **除外パターン**: プロジェクト特有のパターンを追加

---

## 14. 技術仕様

### 14.1 依存関係

- **Python**: 3.8+
- **LLM API**: OpenAI GPT-4o
- **Excel処理**: openpyxl, pandas
- **ログ**: loguru
- **設定**: PyYAML

### 14.2 アーキテクチャ

- **モジュラー設計**: 各機能を独立したモジュールで実装
- **設定駆動**: YAMLファイルによる柔軟な設定管理
- **ログ管理**: 詳細なリクエストログと実行ログ
- **エラー処理**: 堅牢なエラーハンドリングとリカバリ
- **ハイブリッド検出**: 機械的検出とLLM検出の組み合わせによる最適化

---

## 15. 主要技術変更履歴

### v1.1 機械的検出機能をクロスファイル用語統一チェックに更新

**変更内容**:
- **正規化処理を削除**: normalize.pyとneologdn依存を完全に削除
- **元テキスト使用**: 機械的検出・LLM検出ともに元テキストを直接処理
- **用語抽出改善**: 半角カタカナ（ｦ-ﾟ）を含む正確な文字種別抽出
- **処理フロー簡素化**: [Excel読込] → [機械的検出] → [LLMレビュー] → [結果統合] → [出力]

**効果**:
- **検出精度向上**: 「ログイン」と「ﾛｸﾞｲﾝ」などの表記ゆれを正確に検出
- **文脈理解強化**: LLMが元テキストの文脈をより正確に理解
- **処理の簡潔性**: 不要な正規化処理を削除してシンプルに

---

> このツールは機械的検出とLLMの組み合わせにより、確実性と網羅性を両立したシステム設計書の校正作業を効率化します。
> **元テキストを保持した用語統一チェック**とLLMの高度な文脈理解能力を組み合わせることで、
> 従来のアルゴリズムベースの検出やLLM単独では困難だった高精度・高信頼度な誤字脱字検出を実現しています。